# Dracut script
FROM scratch AS build
COPY build /

# Need to wait for this before Fedora 42!
# https://github.com/linux-surface/linux-surface/issues/1735
FROM ghcr.io/ublue-os/kinoite-main:41

# Warning: This script is very slow on a real Surface (6 Pro)
# It's probably best to consider building this in the cloud on a regular basis.
#
# Install the Surface kernel
#
# 1. Install Surface kernel from linux-surface.repo
# 2. Remove existing kernel, so bootc knows which kernel to boot (cannot have more than one kernel)
# 3. Disable the watchdog (there will only ever be one kernel in the image)
# 4. Regenerate initramfs with ostree support if the kerner version has changed
# 5. Delete /boot
#
# The files in /boot also exist in /lib/modules/$KVER, except for initramfs.img which needs to be regenerated by dracut
# I tried copying the initramfs from /boot to /lib/modules, but I got the following error:
# Failed to switch root: Specified switch root path '/sysroot' does not seem to be an OS tree. os-release file is missing.
RUN --mount=type=bind,from=build,source=/,target=/build \
    --mount=type=cache,dst=/var/cache \
    --mount=type=cache,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    dnf5 config-manager \
        addrepo --from-repofile=https://pkg.surfacelinux.com/fedora/linux-surface.repo && \
    dnf5 install  -y --setopt=keepcache=1 --allowerasing \
        kernel-surface iptsd libwacom-surface libwacom-surface-data && \
    dnf5 remove -y --setopt=keepcache=1 \
        kernel kernel-core kernel-modules kernel-modules-extra && \
    systemctl disable linux-surface-default-watchdog.path && \
    /build/initramfs.sh && \
    rm -rf /boot/.vmlinuz* /boot/* && echo "OK!"

# Clean var folder to pass linting checks.
RUN rm -rf /var/* && ostree container commit

RUN bootc container lint
